<!DOCTYPE html>
<html>
<head>
    <title>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #1a1a1a; color: white; min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
        .container { background: #2d2d2d; border-radius: 15px; padding: 30px; max-width: 500px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { text-align: center; color: #4CAF50; margin-bottom: 25px; }
        .screen { display: none; }
        .screen.active { display: block; }
        input, button { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; font-size: 16px; }
        input { background: #3a3a3a; border: 2px solid #444; color: white; }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        button:hover { background: #45a049; transform: translateY(-2px); }
        button:disabled { background: #666; cursor: not-allowed; }
        .btn-copy { background: #2196F3; }
        .btn-copy:hover { background: #1976D2; }
        .btn-leave { background: #f44336; }
        .btn-leave:hover { background: #d32f2f; }
        .status { padding: 12px; text-align: center; border-radius: 8px; margin: 15px 0; font-weight: bold; }
        .online { background: #2e7d32; }
        .offline { background: #c62828; }
        .users { background: #3a3a3a; padding: 20px; border-radius: 10px; margin: 20px 0; min-height: 150px; }
        .user { padding: 10px; background: #2d2d2d; margin: 8px 0; border-radius: 5px; border-left: 4px solid #4CAF50; }
        .link-box { background: #333; padding: 15px; border-radius: 10px; margin: 20px 0; word-break: break-all; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 25px 0; }
        .mic-on { background: #4CAF50; }
        .mic-off { background: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="connectScreen" class="screen active">
            <h1>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç –¥–ª—è –¥—Ä—É–∑–µ–π</h1>
            <p style="color: #bbb; margin-bottom: 20px; text-align: center;">–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–≥–∞!</p>
            <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è" value="–î—Ä—É–≥">
            <input type="text" id="roomId" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="main-room">
            <button onclick="joinRoom()" id="joinBtn">‚úÖ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
            <div class="status offline" id="status">–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É"</div>
            <p style="color: #4CAF50; text-align: center; font-size: 14px; margin-top: 20px;">‚úÖ HTTPS –≤–∫–ª—é—á—ë–Ω ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!</p>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
        <div id="chatScreen" class="screen">
            <h1>üé§ <span id="roomTitle">–ö–æ–º–Ω–∞—Ç–∞</span></h1>
            <div class="users">
                <h3>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="userCount">0</span>):</h3>
                <div id="userList"></div>
            </div>
            <div class="controls">
                <button id="micBtn" class="mic-on" onclick="toggleMic()">üé§ –í–∫–ª</button>
                <button class="btn-copy" onclick="copyLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
            <div class="link-box">
                <strong>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É:</strong><br>
                <span id="inviteLink">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <button class="btn-leave" onclick="leaveRoom()">üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
    </div>

    <script>
        let currentRoom = '', currentUser = '', localStream = null, isMuted = false;
        let usersInRoom = new Map(); // –•—Ä–∞–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: –∏–º—è -> –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

        // –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É
        async function joinRoom() {
            currentUser = document.getElementById('username').value.trim() || '–î—Ä—É–≥';
            currentRoom = document.getElementById('roomId').value.trim() || 'main-room';

            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = true;
            joinBtn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';

            try {
                // –ó–∞–ø—Ä–æ—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true } 
                });
                updateStatus('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω!', true);

                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —á–∞—Ç—É
                document.getElementById('connectScreen').classList.remove('active');
                document.getElementById('chatScreen').classList.add('active');
                document.getElementById('roomTitle').textContent = currentRoom;

                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
                const baseUrl = window.location.href.split('?')[0];
                const inviteUrl = `${baseUrl}?room=${encodeURIComponent(currentRoom)}`;
                document.getElementById('inviteLink').textContent = inviteUrl;

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –∏ –Ω–∞—á–∏–Ω–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                addOrUpdateUser(currentUser);
                startUserMonitoring();

                updateStatus('‚úÖ –ì–æ—Ç–æ–≤ –∫ –æ–±—â–µ–Ω–∏—é!', true);

            } catch (error) {
                joinBtn.disabled = false;
                joinBtn.textContent = '‚úÖ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É';
                if (error.name === 'NotAllowedError') {
                    updateStatus('‚ùå –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ', false);
                    alert('–ß—Ç–æ–±—ã –æ–±—â–∞—Ç—å—Å—è, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É üîí —Å–ª–µ–≤–∞ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.');
                } else {
                    updateStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, false);
                }
            }
        }

        // –°–∏—Å—Ç–µ–º–∞ "–ø–∏–Ω–≥–æ–≤" —á–µ—Ä–µ–∑ localStorage –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function startUserMonitoring() {
            const roomKey = `voicechat_${currentRoom}`;

            // –ö–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ—ë –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ
            setInterval(() => {
                addOrUpdateUser(currentUser);
                loadOtherUsers(roomKey);
            }, 2000);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å—Ä–∞–∑—É
            loadOtherUsers(roomKey);
        }

        function addOrUpdateUser(userName) {
            const roomKey = `voicechat_${currentRoom}`;
            let roomUsers = JSON.parse(localStorage.getItem(roomKey)) || {};
            roomUsers[userName] = Date.now(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
            localStorage.setItem(roomKey, JSON.stringify(roomUsers));
            usersInRoom.set(userName, Date.now());
            renderUserList();
        }

        function loadOtherUsers(roomKey) {
            const now = Date.now();
            const tenSecondsAgo = now - 10000; // –£—á–∞—Å—Ç–Ω–∏–∫ "–∂–∏–≤", –µ—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –º–µ–Ω–µ–µ 10 —Å–µ–∫ –Ω–∞–∑–∞–¥

            let roomUsers = JSON.parse(localStorage.getItem(roomKey)) || {};
            // –û—á–∏—â–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö
            for (const [user, timestamp] of Object.entries(roomUsers)) {
                if (timestamp < tenSecondsAgo) {
                    delete roomUsers[user];
                }
            }
            localStorage.setItem(roomKey, JSON.stringify(roomUsers));

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ—é –∫–∞—Ä—Ç—É
            usersInRoom.clear();
            for (const [user, timestamp] of Object.entries(roomUsers)) {
                usersInRoom.set(user, timestamp);
            }
            renderUserList();
        }

        function renderUserList() {
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            userList.innerHTML = '';
            usersInRoom.forEach((timestamp, user) => {
                const div = document.createElement('div');
                div.className = 'user';
                div.innerHTML = `<strong>${user}</strong> ${user === currentUser ? '<span style="color:#4CAF50;">(–í—ã)</span>' : ''}`;
                userList.appendChild(div);
            });
            userCount.textContent = usersInRoom.size;
        }

        function updateStatus(msg, isOk) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = msg;
            statusEl.className = `status ${isOk ? 'online' : 'offline'}`;
        }

        function toggleMic() {
            if (!localStream) return;
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            const micBtn = document.getElementById('micBtn');
            if (isMuted) {
                micBtn.textContent = 'üîá –í—ã–∫–ª';
                micBtn.className = 'mic-off';
                updateStatus('üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω', true);
            } else {
                micBtn.textContent = 'üé§ –í–∫–ª';
                micBtn.className = 'mic-on';
                updateStatus('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω', true);
            }
        }

        function copyLink() {
            const link = document.getElementById('inviteLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                updateStatus('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä!', true);
            });
        }

        function leaveRoom() {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            const roomKey = `voicechat_${currentRoom}`;
            let roomUsers = JSON.parse(localStorage.getItem(roomKey)) || {};
            delete roomUsers[currentUser]; // –£–¥–∞–ª—è–µ–º —Å–µ–±—è –∏–∑ —Å–ø–∏—Å–∫–∞
            localStorage.setItem(roomKey, JSON.stringify(roomUsers));

            document.getElementById('chatScreen').classList.remove('active');
            document.getElementById('connectScreen').classList.add('active');
            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = false;
            joinBtn.textContent = '‚úÖ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É';
            updateStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', false);
            usersInRoom.clear();
        }

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä ?room= –≤ URL
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            if (roomFromUrl) document.getElementById('roomId').value = roomFromUrl;
            updateStatus('‚úÖ –°–∞–π—Ç –Ω–∞ HTTPS ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!', true);
        };
        window.onbeforeunload = leaveRoom;
    </script>
</body>
</html>
