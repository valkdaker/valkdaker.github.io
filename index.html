<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç –¥–ª—è –¥—Ä—É–∑–µ–π</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .screen.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .input-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }
        input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #4CAF50;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.4);
        }
        button:active {
            transform: translateY(-1px);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }
        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(33, 150, 243, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }
        .btn-danger:hover {
            box-shadow: 0 10px 20px rgba(244, 67, 54, 0.4);
        }
        .status {
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid transparent;
        }
        .status-online {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            color: #c8e6c9;
        }
        .status-offline {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
            color: #ffcdd2;
        }
        .status-connecting {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
            color: #fff8e1;
        }
        .users-panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .users-list {
            min-height: 120px;
        }
        .user-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 4px solid #4CAF50;
            transition: all 0.3s;
        }
        .user-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .user-card.you {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }
        .user-card.talking {
            border-left-color: #FF9800;
            background: rgba(255, 152, 0, 0.1);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }
        .control-btn {
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .control-btn:hover {
            transform: translateY(-2px);
        }
        .mic-on {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
            color: white;
        }
        .mic-off {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
        .link-box {
            background: rgba(33, 150, 243, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
        .link-text {
            word-break: break-all;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .audio-wave {
            display: inline-flex;
            align-items: flex-end;
            height: 30px;
            margin-left: 10px;
        }
        .audio-wave span {
            display: inline-block;
            width: 4px;
            margin: 0 2px;
            background: #4CAF50;
            border-radius: 2px;
            animation: audioWave 1.4s ease infinite;
        }
        .audio-wave span:nth-child(2) { animation-delay: 0.2s; }
        .audio-wave span:nth-child(3) { animation-delay: 0.4s; }
        .audio-wave span:nth-child(4) { animation-delay: 0.6s; }
        .audio-wave span:nth-child(5) { animation-delay: 0.8s; }
        @keyframes audioWave {
            0%, 100% { height: 5px; }
            50% { height: 20px; }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            display: none;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        @media (max-width: 600px) {
            .container { padding: 20px; }
            .controls { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="connectScreen" class="screen active">
            <h1>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç –¥–ª—è –¥—Ä—É–∑–µ–π</h1>
            
            <div class="input-group">
                <label for="username">üìõ –í–∞—à–µ –∏–º—è:</label>
                <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" value="–î—Ä—É–≥">
            </div>
            
            <div class="input-group">
                <label for="roomId">üö™ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:</label>
                <input type="text" id="roomId" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="–º–æ–π-—á–∞—Ç">
            </div>
            
            <button id="joinBtn" onclick="joinRoom()">
                <span>‚úÖ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</span>
            </button>
            
            <div class="status status-offline" id="status">
                –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é...
            </div>
            
            <div style="text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-top: 30px; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 10px;">
                üí° <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
                1. –í–æ–π–¥–∏—Ç–µ –≤ –∫–æ–º–Ω–∞—Ç—É ‚Üí 2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É ‚Üí 3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É ‚Üí 4. –û–±—â–∞–π—Ç–µ—Å—å!
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
        <div id="chatScreen" class="screen">
            <h1>üé§ <span id="roomTitle">–ö–æ–º–Ω–∞—Ç–∞</span></h1>
            
            <div class="users-panel">
                <div class="users-header">
                    <h3 style="color: white;">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                    <div style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="userCount">1</div>
                </div>
                <div class="users-list" id="usersList">
                    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <div class="status status-online" id="chatStatus">
                <span id="connectionText">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ</span>
                <div class="audio-wave" id="audioWave" style="display: none;">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
            </div>
            
            <div class="controls">
                <button id="micBtn" class="control-btn mic-on" onclick="toggleMicrophone()">
                    <span>üé§</span>
                    <span id="micText">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –í–ö–õ</span>
                </button>
                <button class="control-btn btn-secondary" onclick="copyInviteLink()">
                    <span>üìã</span>
                    <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</span>
                </button>
            </div>
            
            <div class="link-box">
                <div style="font-weight: bold; color: #90CAF9; margin-bottom: 10px;">üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–∑–µ–π:</div>
                <div class="link-text" id="inviteLink">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <button onclick="shareRoom()" style="width: 100%; margin-top: 10px;">
                    <span>üì§</span>
                    <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–º–Ω–∞—Ç–æ–π</span>
                </button>
            </div>
            
            <button class="btn-danger" onclick="leaveRoom()">
                <span>üö™</span>
                <span>–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</span>
            </button>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="notification" id="notification"></div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const PEERJS_CONFIG = {
            host: '0.peerjs.com',
            port: 443,
            path: '/',
            secure: true,
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            }
        };

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let localStream = null;
        let peer = null;
        let connections = new Map(); // –•—Ä–∞–Ω–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        let users = new Map(); // –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
        let currentRoom = '';
        let currentUser = '';
        let isMuted = false;
        let isSpeaking = false;
        let audioContext = null;
        let analyser = null;
        let audioCheckInterval = null;

        // ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#f44336' : 
                                          type === 'warning' ? '#ff9800' : '#4CAF50';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        function updateStatus(message, type = 'online') {
            const statusEl = document.getElementById('status');
            const chatStatusEl = document.getElementById('chatStatus');
            const connectionText = document.getElementById('connectionText');
            
            statusEl.textContent = message;
            chatStatusEl.textContent = message;
            connectionText.textContent = message;
            
            statusEl.className = `status status-${type}`;
            chatStatusEl.className = `status status-${type}`;
        }

        // –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É
        async function joinRoom() {
            currentUser = document.getElementById('username').value.trim() || '–î—Ä—É–≥';
            currentRoom = document.getElementById('roomId').value.trim().toLowerCase().replace(/\s+/g, '-') || '–º–æ–π-—á–∞—Ç';
            
            if (!currentRoom) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã!', 'error');
                return;
            }
            
            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = true;
            joinBtn.innerHTML = '<span>üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>';
            updateStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'connecting');
            
            try {
                // 1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        channelCount: 1
                    }
                });
                
                console.log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                showNotification('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                updateStatus('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤', 'online');
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                setupAudioAnalysis();
                
                // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º PeerJS
                await initializePeerJS();
                
                // 3. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω —á–∞—Ç–∞
                document.getElementById('connectScreen').classList.remove('active');
                document.getElementById('chatScreen').classList.add('active');
                document.getElementById('roomTitle').textContent = currentRoom;
                
                // 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
                const baseUrl = window.location.origin + window.location.pathname;
                const inviteUrl = `${baseUrl}?room=${encodeURIComponent(currentRoom)}`;
                document.getElementById('inviteLink').textContent = inviteUrl;
                
                // 5. –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                addUser(peer.id, currentUser, true);
                
                updateStatus(`‚úÖ –í—ã –≤ –∫–æ–º–Ω–∞—Ç–µ "${currentRoom}"`, 'online');
                showNotification(`–í—ã –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É "${currentRoom}"`);
                
                // 6. –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                setTimeout(() => discoverOtherUsers(), 1000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                joinBtn.disabled = false;
                joinBtn.innerHTML = '<span>‚úÖ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</span>';
                
                if (error.name === 'NotAllowedError') {
                    const errorMsg = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                    updateStatus('‚ùå –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'offline');
                    showNotification(errorMsg, 'error');
                    alert(`‚ùå ${errorMsg}\n\n1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ\n2. –í—ã–±–µ—Ä–∏—Ç–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞"\n3. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞\n4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É`);
                } else if (error.name === 'NotFoundError') {
                    updateStatus('‚ùå –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', 'offline');
                    showNotification('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.', 'error');
                } else if (error.name === 'NotReadableError') {
                    updateStatus('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'offline');
                    showNotification('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.', 'error');
                } else {
                    updateStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'offline');
                    showNotification(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PeerJS
        async function initializePeerJS() {
            return new Promise((resolve, reject) => {
                try {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–Ω–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
                    const peerId = `${currentRoom}-${currentUser}-${Date.now()}`.replace(/[^a-z0-9-]/gi, '');
                    
                    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PeerJS —Å ID:', peerId);
                    updateStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É PeerJS...', 'connecting');
                    
                    peer = new Peer(peerId, PEERJS_CONFIG);
                    
                    peer.on('open', (id) => {
                        console.log('‚úÖ PeerJS –ø–æ–¥–∫–ª—é—á–µ–Ω, ID:', id);
                        updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É PeerJS', 'online');
                        showNotification('–°–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω');
                        resolve();
                    });
                    
                    peer.on('error', (error) => {
                        console.error('PeerJS –æ—à–∏–±–∫–∞:', error);
                        
                        if (error.type === 'peer-unavailable') {
                            // –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è
                            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è)');
                        } else if (error.type === 'network') {
                            updateStatus('‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é', 'offline');
                            showNotification('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É', 'error');
                        } else if (error.type === 'server-error') {
                            updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'offline');
                            showNotification('–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —Å–≤—è–∑–∏', 'error');
                        } else {
                            updateStatus(`‚ùå –û—à–∏–±–∫–∞ PeerJS: ${error.type}`, 'offline');
                        }
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                    peer.on('connection', (conn) => {
                        console.log('üìû –í—Ö–æ–¥—è—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç:', conn.peer);
                        
                        conn.on('open', () => {
                            console.log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å:', conn.peer);
                            
                            // –û–±–º–µ–Ω–∏–≤–∞–µ–º—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
                            conn.send({
                                type: 'user-info',
                                userId: peer.id,
                                userName: currentUser,
                                roomId: currentRoom
                            });
                            
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                            establishVoiceConnection(conn.peer);
                        });
                        
                        conn.on('data', (data) => {
                            handlePeerData(conn.peer, data);
                        });
                        
                        conn.on('close', () => {
                            console.log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ:', conn.peer);
                            removeUser(conn.peer);
                        });
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤
                    peer.on('call', (call) => {
                        console.log('üìû –í—Ö–æ–¥—è—â–∏–π –≥–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫ –æ—Ç:', call.peer);
                        
                        // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –∑–≤–æ–Ω–æ–∫
                        call.answer(localStream);
                        
                        call.on('stream', (remoteStream) => {
                            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫ –æ—Ç:', call.peer);
                            handleRemoteStream(call.peer, remoteStream);
                        });
                        
                        call.on('close', () => {
                            console.log('‚ùå –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω:', call.peer);
                            removeUser(call.peer);
                        });
                        
                        call.on('error', (error) => {
                            console.error('–û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞:', error);
                        });
                        
                        connections.set(call.peer, call);
                    });
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PeerJS:', error);
                    updateStatus('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'offline');
                    showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                    reject(error);
                }
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ
        function setupAudioAnalysis() {
            if (!window.AudioContext) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                audioCheckInterval = setInterval(checkAudioActivity, 200);
                
            } catch (error) {
                console.warn('–ê–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        function checkAudioActivity() {
            if (!analyser || !audioContext) return;
            
            try {
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                const average = sum / dataArray.length;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–æ–≤–æ—Ä–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                const speaking = average > 10 && !isMuted;
                
                if (speaking !== isSpeaking) {
                    isSpeaking = speaking;
                    updateUserSpeakingStatus(peer.id, speaking);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –≤–æ–ª–Ω—ã
                    const audioWave = document.getElementById('audioWave');
                    if (speaking) {
                        audioWave.style.display = 'inline-flex';
                        updateStatus('üé§ –í—ã –≥–æ–≤–æ—Ä–∏—Ç–µ...', 'online');
                    } else {
                        audioWave.style.display = 'none';
                        updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'online');
                    }
                }
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ:', error);
            }
        }

        // –ü–æ–∏—Å–∫ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–æ–º–Ω–∞—Ç–µ
        function discoverOtherUsers() {
            // PeerJS –Ω–µ –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–∏—Å–∫–∞ –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º,
            // –ø–æ—ç—Ç–æ–º—É –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏
            const roomKey = `voicechat-room-${currentRoom}`;
            const myInfo = {
                peerId: peer.id,
                userName: currentUser,
                timestamp: Date.now()
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
            let roomUsers = JSON.parse(localStorage.getItem(roomKey)) || {};
            roomUsers[peer.id] = myInfo;
            localStorage.setItem(roomKey, JSON.stringify(roomUsers));
            
            // –ò—â–µ–º –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            setInterval(() => {
                try {
                    const allUsers = JSON.parse(localStorage.getItem(roomKey)) || {};
                    const now = Date.now();
                    
                    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (–±–æ–ª—å—à–µ 10 —Å–µ–∫—É–Ω–¥)
                    for (const userId in allUsers) {
                        if (now - allUsers[userId].timestamp > 10000) {
                            delete allUsers[userId];
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ—é –∑–∞–ø–∏—Å—å
                    allUsers[peer.id] = myInfo;
                    localStorage.setItem(roomKey, JSON.stringify(allUsers));
                    
                    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                    for (const userId in allUsers) {
                        if (userId !== peer.id && !connections.has(userId)) {
                            console.log('–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', userId);
                            connectToUser(userId, allUsers[userId].userName);
                        }
                    }
                    
                    // –£–¥–∞–ª—è–µ–º –æ—Ç–∫–ª—é—á–∏–≤—à–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    for (const [userId] of connections) {
                        if (!allUsers[userId] && userId !== peer.id) {
                            removeUser(userId);
                        }
                    }
                    
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                }
            }, 2000);
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        function connectToUser(peerId, userName) {
            if (connections.has(peerId) || !peer) return;
            
            console.log('–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:', peerId);
            
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏
                const conn = peer.connect(peerId, {
                    reliable: true,
                    serialization: 'json'
                });
                
                conn.on('open', () => {
                    console.log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å:', peerId);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
                    conn.send({
                        type: 'user-info',
                        userId: peer.id,
                        userName: currentUser,
                        roomId: currentRoom
                    });
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    establishVoiceConnection(peerId);
                });
                
                conn.on('data', (data) => {
                    handlePeerData(peerId, data);
                });
                
                conn.on('close', () => {
                    console.log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ:', peerId);
                    removeUser(peerId);
                });
                
                conn.on('error', (error) => {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:', error);
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function establishVoiceConnection(targetPeerId) {
            if (!localStream || connections.has(targetPeerId)) return;
            
            console.log('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å:', targetPeerId);
            
            try {
                const call = peer.call(targetPeerId, localStream);
                
                call.on('stream', (remoteStream) => {
                    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫ –æ—Ç:', targetPeerId);
                    handleRemoteStream(targetPeerId, remoteStream);
                });
                
                call.on('close', () => {
                    console.log('‚ùå –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ:', targetPeerId);
                    removeUser(targetPeerId);
                });
                
                call.on('error', (error) => {
                    console.error('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
                });
                
                connections.set(targetPeerId, call);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–∏—Ä–æ–≤
        function handlePeerData(peerId, data) {
            switch (data.type) {
                case 'user-info':
                    addUser(peerId, data.userName, false);
                    break;
                case 'speaking-status':
                    updateUserSpeakingStatus(peerId, data.isSpeaking);
                    break;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–∞
        function handleRemoteStream(peerId, stream) {
            try {
                // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                const audio = new Audio();
                audio.srcObject = stream;
                audio.autoplay = true;
                audio.volume = 1.0;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç
                if (users.has(peerId)) {
                    const user = users.get(peerId);
                    user.audioElement = audio;
                    users.set(peerId, user);
                }
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ
                setupRemoteAudioAnalysis(peerId, stream);
                
                console.log('‚úÖ –ê—É–¥–∏–æ–ø–æ—Ç–æ–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –¥–ª—è:', peerId);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞:', error);
            }
        }

        // –ê–Ω–∞–ª–∏–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≥–æ–≤–æ—Ä—è—â–µ–≥–æ
        function setupRemoteAudioAnalysis(peerId, stream) {
            if (!window.AudioContext) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                // –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                setInterval(() => {
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / dataArray.length;
                    
                    // –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞ –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç
                    updateUserSpeakingStatus(peerId, average > 5);
                    
                }, 500);
                
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ:', error);
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫
        function addUser(peerId, userName, isYou = false) {
            if (users.has(peerId)) return;
            
            console.log('–î–æ–±–∞–≤–ª—è—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userName, peerId);
            
            users.set(peerId, {
                id: peerId,
                name: userName,
                isYou: isYou,
                isSpeaking: false,
                audioElement: null
            });
            
            updateUsersList();
            showNotification(`${userName} ${isYou ? '(–í—ã)' : ''} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è`);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "–≥–æ–≤–æ—Ä–∏—Ç/–º–æ–ª—á–∏—Ç"
        function updateUserSpeakingStatus(peerId, isSpeaking) {
            if (!users.has(peerId)) return;
            
            const user = users.get(peerId);
            if (user.isSpeaking !== isSpeaking) {
                user.isSpeaking = isSpeaking;
                users.set(peerId, user);
                updateUsersList();
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function removeUser(peerId) {
            if (!users.has(peerId)) return;
            
            const user = users.get(peerId);
            console.log('–£–¥–∞–ª—è—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user.name);
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç
            if (user.audioElement) {
                user.audioElement.pause();
                user.audioElement.srcObject = null;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (connections.has(peerId)) {
                connections.get(peerId).close();
                connections.delete(peerId);
            }
            
            users.delete(peerId);
            updateUsersList();
            
            if (!user.isYou) {
                showNotification(`${user.name} –æ—Ç–∫–ª—é—á–∏–ª—Å—è`);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateUsersList() {
            const usersList = document.getElementById('usersList');
            const userCount = document.getElementById('userCount');
            
            usersList.innerHTML = '';
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ "–í—ã", –∑–∞—Ç–µ–º –¥—Ä—É–≥–∏–µ
            const sortedUsers = Array.from(users.values()).sort((a, b) => {
                if (a.isYou && !b.isYou) return -1;
                if (!a.isYou && b.isYou) return 1;
                return a.name.localeCompare(b.name);
            });
            
            sortedUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = `user-card ${user.isYou ? 'you' : ''} ${user.isSpeaking ? 'talking' : ''}`;
                userCard.id = `user-${user.id}`;
                
                userCard.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <
