<!DOCTYPE html>
<html>
<head>
    <title>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç –¥–ª—è –¥—Ä—É–∑–µ–π</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #0f172a; color: #f8fafc; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: #1e293b; border-radius: 20px; padding: 30px; width: 100%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid #334155; }
        h1 { text-align: center; color: #60a5fa; margin-bottom: 25px; font-size: 28px; }
        .screen { display: none; }
        .screen.active { display: block; }
        input, button { width: 100%; padding: 15px; margin: 12px 0; border-radius: 12px; font-size: 16px; border: none; }
        input { background: #334155; color: white; border: 2px solid #475569; }
        input:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.2); }
        button { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        button:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(59,130,246,0.4); }
        button:disabled { background: #475569; cursor: not-allowed; transform: none; }
        .btn-copy { background: linear-gradient(135deg, #10b981, #34d399); }
        .btn-leave { background: linear-gradient(135deg, #ef4444, #f87171); }
        .status { padding: 15px; text-align: center; border-radius: 10px; margin: 20px 0; font-weight: bold; }
        .online { background: rgba(34,197,94,0.2); border: 2px solid #22c55e; color: #86efac; }
        .offline { background: rgba(239,68,68,0.2); border: 2px solid #ef4444; color: #fca5a5; }
        .users { background: #334155; padding: 20px; border-radius: 15px; margin: 25px 0; min-height: 200px; border: 1px solid #475569; }
        .user { padding: 12px; background: #1e293b; margin: 10px 0; border-radius: 8px; border-left: 4px solid #60a5fa; display: flex; justify-content: space-between; align-items: center; }
        .link-box { background: #334155; padding: 20px; border-radius: 15px; margin: 25px 0; word-break: break-all; border: 1px solid #475569; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .mic-on { background: linear-gradient(135deg, #22c55e, #4ade80); }
        .mic-off { background: linear-gradient(135deg, #ef4444, #f87171); }
        .mic-on, .mic-off { padding: 15px; font-size: 18px; }
        .connection-status { font-size: 14px; color: #94a3b8; margin-top: 10px; text-align: center; }
        .audio-wave { display: inline-block; margin-left: 10px; }
        @keyframes wave { 0%, 60%, 100% { height: 10px; } 30% { height: 20px; } }
        .audio-wave span { display: inline-block; width: 4px; height: 10px; margin: 0 2px; background: #22c55e; border-radius: 2px; animation: wave 1.4s infinite; }
        .audio-wave span:nth-child(2) { animation-delay: 0.2s; }
        .audio-wave span:nth-child(3) { animation-delay: 0.4s; }
        .audio-wave span:nth-child(4) { animation-delay: 0.6s; }
        .audio-wave span:nth-child(5) { animation-delay: 0.8s; }
        .talking { border-left-color: #22c55e !important; background: rgba(34,197,94,0.1) !important; }
    </style>
    <!-- Socket.io –∫–ª–∏–µ–Ω—Ç -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="connectScreen" class="screen active">
            <h1>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç –¥–ª—è –¥—Ä—É–∑–µ–π</h1>
            <p style="color: #cbd5e1; margin-bottom: 30px; text-align: center;">–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–≥–∞ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è!</p>
            <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è" value="–î—Ä—É–≥">
            <input type="text" id="roomId" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="–∫–æ–º–Ω–∞—Ç–∞">
            <button onclick="joinRoom()" id="joinBtn">‚úÖ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
            <div class="status offline" id="status">–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É"</div>
            <p style="color: #86efac; text-align: center; font-size: 14px; margin-top: 25px; padding: 12px; background: rgba(34,197,94,0.1); border-radius: 8px; border: 1px solid #22c55e;">
                ‚úÖ HTTPS –≤–∫–ª—é—á–µ–Ω ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!
            </p>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
        <div id="chatScreen" class="screen">
            <h1>üé§ <span id="roomTitle">–ö–æ–º–Ω–∞—Ç–∞</span></h1>
            <div class="users">
                <h3 style="margin-bottom: 15px; color: #cbd5e1;">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="userCount">0</span>):</h3>
                <div id="userList"></div>
            </div>
            <div class="connection-status" id="connectionInfo">
                <span id="audioStatus">üîá –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π</span>
                <div class="audio-wave" id="audioWave" style="display: none;">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
            </div>
            <div class="controls">
                <button id="micBtn" class="mic-on" onclick="toggleMic()">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –í–∫–ª</button>
                <button class="btn-copy" onclick="copyLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
            <div class="link-box">
                <strong style="color: #60a5fa;">üîó –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É:</strong><br><br>
                <span id="inviteLink" style="color: #cbd5e1;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <button class="btn-leave" onclick="leaveRoom()">üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        // üîß –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ URL –Ω–∞ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞!
        const SIGNAL_SERVER_URL = 'https://voice-chat-server-0001.onrender.com';
        
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentRoom = '';
        let currentUser = '';
        let localStream = null;
        let isMuted = false;
        let socket = null;
        let peerConnections = {}; // –•—Ä–∞–Ω–∏—Ç –≤—Å–µ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {userId: peer}
        let audioContext = null;
        let analyser = null;
        let isTalking = false;

        // ==================== –§–£–ù–ö–¶–ò–ò ====================

        // –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É
        async function joinRoom() {
            currentUser = document.getElementById('username').value.trim() || '–î—Ä—É–≥';
            currentRoom = document.getElementById('roomId').value.trim() || '–∫–æ–º–Ω–∞—Ç–∞';

            if (!currentRoom) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã!');
                return;
            }

            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = true;
            joinBtn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            updateStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...', false);

            try {
                // 1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                console.log('‚úÖ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω!');
                setupAudioAnalysis(); // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ

                // 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
                connectToSignalServer();

                // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —á–∞—Ç–∞
                document.getElementById('connectScreen').classList.remove('active');
                document.getElementById('chatScreen').classList.add('active');
                document.getElementById('roomTitle').textContent = currentRoom;

                // 4. –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
                const baseUrl = window.location.href.split('?')[0];
                const inviteUrl = `${baseUrl}?room=${encodeURIComponent(currentRoom)}`;
                document.getElementById('inviteLink').textContent = inviteUrl;

                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ!', true);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                joinBtn.disabled = false;
                joinBtn.textContent = '‚úÖ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É';
                
                if (error.name === 'NotAllowedError') {
                    alert('‚ùå –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É!\n\n1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ\n2. –í—ã–±–µ—Ä–∏—Ç–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞"\n3. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞\n4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                    updateStatus('‚ùå –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω', false);
                } else if (error.name === 'NotFoundError') {
                    alert('‚ùå –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.');
                    updateStatus('‚ùå –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', false);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                    updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', false);
                }
            }
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
        function connectToSignalServer() {
            console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É:', SIGNAL_SERVER_URL);
            socket = io(SIGNAL_SERVER_URL, {
                transports: ['websocket', 'polling'],
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Socket.io
            socket.on('connect', () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É');
                updateStatus('‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω', true);
                socket.emit('join-room', currentRoom, currentUser, socket.id);
            });

            socket.on('room-users', (users) => {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ:', users);
                updateUserList(users);
                users.forEach(user => {
                    if (user.id !== socket.id) {
                        createPeerConnection(user.id, user.name);
                    }
                });
            });

            socket.on('user-joined', (user) => {
                console.log('–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user);
                updateStatus(`üë§ ${user.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`, true);
                if (user.id !== socket.id) {
                    createPeerConnection(user.id, user.name);
                }
                addUserToList(user);
            });

            socket.on('user-left', (userId) => {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª:', userId);
                if (peerConnections[userId]) {
                    peerConnections[userId].close();
                    delete peerConnections[userId];
                }
                removeUserFromList(userId);
            });

            socket.on('webrtc-offer', ({ from, offer }) => {
                console.log('–ü–æ–ª—É—á–µ–Ω offer –æ—Ç:', from);
                handleWebRTCOffer(from, offer);
            });

            socket.on('webrtc-answer', ({ from, answer }) => {
                console.log('–ü–æ–ª—É—á–µ–Ω answer –æ—Ç:', from);
                handleWebRTCAnswer(from, answer);
            });

            socket.on('webrtc-ice-candidate', ({ from, candidate }) => {
                console.log('–ü–æ–ª—É—á–µ–Ω ICE candidate –æ—Ç:', from);
                handleICECandidate(from, candidate);
            });

            socket.on('user-audio-status', ({ userId, isSpeaking }) => {
                updateUserAudioStatus(userId, isSpeaking);
            });

            socket.on('disconnect', () => {
                console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                updateStatus('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', false);
                document.getElementById('audioWave').style.display = 'none';
            });

            socket.on('connect_error', (error) => {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', false);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function createPeerConnection(targetUserId, targetUserName) {
            if (peerConnections[targetUserId]) {
                console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', targetUserId);
                return;
            }

            console.log('–°–æ–∑–¥–∞—é P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å:', targetUserId);

            const peer = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peer.addTrack(track, localStream);
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π WebRTC
            peer.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-ice-candidate', {
                        to: targetUserId,
                        candidate: event.candidate
                    });
                }
            };

            peer.ontrack = (event) => {
                console.log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –æ—Ç:', targetUserId);
                const remoteAudio = new Audio();
                remoteAudio.srcObject = event.streams[0];
                remoteAudio.play();
                remoteAudio.volume = 1.0;
                
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                setupRemoteAudioAnalysis(event.streams[0], targetUserId);
            };

            peer.onconnectionstatechange = () => {
                console.log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${targetUserName}:`, peer.connectionState);
                updateConnectionInfo();
            };

            peer.onsignalingstatechange = () => {
                console.log(`–°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å ${targetUserName}:`, peer.signalingState);
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            peerConnections[targetUserId] = peer;
            peer.targetName = targetUserName;

            // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
            createAndSendOffer(targetUserId, peer);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ offer
        async function createAndSendOffer(targetUserId, peer) {
            try {
                const offer = await peer.createOffer();
                await peer.setLocalDescription(offer);
                
                socket.emit('webrtc-offer', {
                    to: targetUserId,
                    offer: offer
                });
                
                console.log('Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫:', targetUserId);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ offer
        async function handleWebRTCOffer(from, offer) {
            console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é offer –æ—Ç:', from);
            
            if (!peerConnections[from]) {
                createPeerConnection(from, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
            }
            
            const peer = peerConnections[from];
            
            try {
                await peer.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peer.createAnswer();
                await peer.setLocalDescription(answer);
                
                socket.emit('webrtc-answer', {
                    to: from,
                    answer: answer
                });
                
                console.log('Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫:', from);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ answer
        async function handleWebRTCAnswer(from, answer) {
            console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é answer –æ—Ç:', from);
            
            const peer = peerConnections[from];
            if (peer) {
                try {
                    await peer.setRemoteDescription(new RTCSessionDescription(answer));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer:', error);
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE candidates
        async function handleICECandidate(from, candidate) {
            const peer = peerConnections[from];
            if (peer) {
                try {
                    await peer.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE candidate:', error);
                }
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ (–¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
        function setupAudioAnalysis() {
            if (!localStream || !window.AudioContext) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(localStream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                setInterval(() => {
                    if (socket && socket.connected) {
                        const dataArray = new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(dataArray);
                        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                        const speaking = average > 10 && !isMuted;
                        
                        if (speaking !== isTalking) {
                            isTalking = speaking;
                            socket.emit('user-audio-status', {
                                isSpeaking: speaking
                            });
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
                            const audioWave = document.getElementById('audioWave');
                            if (speaking) {
                                audioWave.style.display = 'inline-block';
                                document.getElementById('audioStatus').textContent = 'üé§ –í—ã –≥–æ–≤–æ—Ä–∏—Ç–µ';
                            } else {
                                audioWave.style.display = 'none';
                                document.getElementById('audioStatus').textContent = 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
                            }
                        }
                    }
                }, 500);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ:', error);
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ
        function setupRemoteAudioAnalysis(stream, userId) {
            if (!window.AudioContext) return;
            
            try {
                const remoteAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                const remoteAnalyser = remoteAudioContext.createAnalyser();
                const remoteSource = remoteAudioContext.createMediaStreamSource(stream);
                remoteSource.connect(remoteAnalyser);
                remoteAnalyser.fftSize = 256;
                
                // –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                setInterval(() => {
                    const dataArray = new Uint8Array(remoteAnalyser.frequencyBinCount);
                    remoteAnalyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    const isSpeaking = average > 5;
                    
                    updateUserAudioStatus(userId, isSpeaking);
                }, 500);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateUserList(users) {
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            
            userList.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –ø–µ—Ä–≤—ã–º
            const selfItem = document.createElement('div');
            selfItem.className = 'user';
            selfItem.id = `user-${socket.id}`;
            selfItem.innerHTML = `
                <span><strong>${currentUser}</strong> <span style="color: #60a5fa;">(–í—ã)</span></span>
                <span style="color: ${isMuted ? '#f87171' : '#4ade80'}">
                    ${isMuted ? 'üîá' : 'üé§'}
                </span>
            `;
            userList.appendChild(selfItem);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            users.forEach(user => {
                if (user.id !== socket.id) {
                    const userItem = document.createElement('div');
                    userItem.className = 'user';
                    userItem.id = `user-${user.id}`;
                    userItem.innerHTML = `
                        <span><strong>${user.name}</strong></span>
                        <span style="color: #94a3b8;">üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                    `;
                    userList.appendChild(userItem);
                }
            });
            
            userCount.textContent = users.length;
        }

        function addUserToList(user) {
            if (user.id === socket.id) return;
            
            const userList = document.getElementById('userList');
            const existingUser = document.getElementById(`user-${user.id}`);
            
            if (!existingUser) {
                const userItem = document.createElement('div');
                userItem.className = 'user';
                userItem.id = `user-${user.id}`;
                userItem.innerHTML = `
                    <span><strong>${user.name}</strong></span>
                    <span style="color: #94a3b8;">üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                `;
                userList.appendChild(userItem);
                
                const userCount = document.getElementById('userCount');
                userCount.textContent = parseInt(userCount.textContent) + 1;
            }
        }

        function removeUserFromList(userId) {
            const userElement = document.getElementById(`user-${userId}`);
            if (userElement) {
                userElement.remove();
                const userCount = document.getElementById('userCount');
                userCount.textContent = parseInt(userCount.textContent) - 1;
            }
        }

        function updateUserAudioStatus(userId, isSpeaking) {
            const userElement = document.getElementById(`user-${userId}`);
            if (userElement) {
                const statusSpan = userElement.querySelector('span:last-child');
                if (statusSpan) {
                    if (isSpeaking) {
                        statusSpan.innerHTML = '<span style="color:#22c55e;">üé§ –ì–æ–≤–æ—Ä–∏—Ç...</span>';
                        userElement.classList.add('talking');
                    } else {
                        statusSpan.innerHTML = '<span style="color:#94a3b8;">üîá –¢–∏—à–∏–Ω–∞</span>';
                        userElement.classList.remove('talking');
                    }
                }
            }
        }

        function updateConnectionInfo() {
            const activeConnections = Object.values(peerConnections).filter(
                peer => peer.connectionState === 'connected'
            ).length;
            
            const info = document.getElementById('connectionInfo');
            if (activeConnections > 0) {
                document.getElementById('audioStatus').textContent = 
                    `‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${activeConnections}`;
            } else {
                document.getElementById('audioStatus').textContent = 
                    'üîÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π...';
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        function toggleMic() {
            if (!localStream) return;
            
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            
            const micBtn = document.getElementById('micBtn');
            const userElement = document.getElementById(`user-${socket.id}`);
            const statusSpan = userElement ? userElement.querySelector('span:last-child') : null;
            
            if (isMuted) {
                micBtn.textContent = 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –í—ã–∫–ª';
                micBtn.className = 'mic-off';
                updateStatus('üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω', true);
                document.getElementById('audioWave').style.display = 'none';
                document.getElementById('audioStatus').textContent = 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω';
                
                if (statusSpan) {
                    statusSpan.innerHTML = '<span style="color:#f87171">üîá –í—ã–∫–ª—é—á–µ–Ω</span>';
                }
            } else {
                micBtn.textContent = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –í–∫–ª';
                micBtn.className = 'mic-on';
                updateStatus('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω', true);
                document.getElementById('audioStatus').textContent = 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
                
                if (statusSpan) {
                    statusSpan.innerHTML = '<span style="color:#4ade80">üé§ –í–∫–ª—é—á–µ–Ω</span>';
                }
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            if (socket) {
                socket.emit('user-audio-status', {
                    isSpeaking: false
                });
            }
        }

        function updateStatus(msg, isOk) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = msg;
            statusEl.className = `status ${isOk ? 'online' : 'offline'}`;
        }

        function copyLink() {
            const link = document.getElementById('inviteLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                updateStatus('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä!', true);
            }).catch(() => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
            });
        }

        function leaveRoom() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            Object.values(peerConnections).forEach(peer => {
                peer.close();
            });
            peerConnections = {};
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            if (socket) {
                socket.disconnect();
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —ç–∫—Ä–∞–Ω—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            document.getElementById('chatScreen').classList.remove('active');
            document.getElementById('connectScreen').classList.add('active');
            
            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = false;
            joinBtn.textContent = '‚úÖ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É';
            
            updateStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', false);
            document.getElementById('userList').innerHTML = '';
            document.getElementById('userCount').textContent = '0';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            currentRoom = '';
            currentUser = '';
            localStream = null;
            isMuted = false;
            socket = null;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            if (roomFromUrl) {
                document.getElementById('roomId').value = roomFromUrl;
            }
            
            updateStatus('‚úÖ –°–∞–π—Ç –Ω–∞ HTTPS ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!', true);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤—É—é —Å–≤—è–∑—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Edge.');
                document.getElementById('joinBtn').disabled = true;
            }
            
            if (!window.RTCPeerConnection) {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebRTC. –û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä.');
                document.getElementById('joinBtn').disabled = true;
            }
        };

        window.onbeforeunload = function() {
            if (socket && socket.connected) {
                socket.disconnect();
            }
        };
    </script>
</body>
</html>
